@using Rsp.IrasPortal.Web.Features.Modifications.Models
@using Rsp.IrasPortal.Application.Constants
@using Rsp.IrasPortal.Application.DTOs.Responses.CmsContent
@using Rsp.IrasPortal.Domain.AccessControl
@model Rsp.IrasPortal.Web.Models.ProjectClosuresModel

@{
    // Title used in the validation error summary
    var errorSummaryTitle = "There is a problem";
    // Retrieve IRAS ID from TempData
    var plannedProjectEndDate = TempData[TempDataKeys.PlannedProjectEndDate];

    var pageContentData = (Dictionary<string, MixedContentPageItem?>?)ViewData[PageContentElements.PageContent];
    var pageContent = pageContentData != null
        ? pageContentData
        : new Dictionary<string, MixedContentPageItem?>();

    var headline = pageContent.GetValueOrDefault("Application.CloseProject.Title", null);
    var body = pageContent.GetValueOrDefault("Application.CloseProject.Body", null);

    // Detect field error for summary styling
    var hasError = ViewData.ModelState.TryGetValue(nameof(Model), out var entry) && entry!.Errors.Any();

}
@section BackNavigation {
    <partial name="_BackNavigation" model="@("pov:postapproval", "Back", new Dictionary<string, string> { { "projectRecordId", Model.ProjectRecordId } })" />
}

<div class="govuk-width-container">
    <form method="post">
        <input type="hidden" name="ProjectRecordId" value="@Model.ProjectRecordId" />
        <input type="hidden" name="IrasId" value="@Model.IrasId" />
        <input type="hidden" name="ShortProjectTitle" value="@Model.ShortProjectTitle" />
        <input type="hidden" name="PlannedProjectEndDate" value="@plannedProjectEndDate" />

        <partial name="_ValidationSummary" model="(ViewData.ModelState, errorSummaryTitle)" />

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                <h1 class="govuk-heading-l">Close Project</h1>
                <div class="govuk-inset-text">
                    <p>
                        <strong>IRAS ID:</strong> @Model.IrasId
                    </p>
                    <p>
                        <strong>Short project title:</strong> @Model.ShortProjectTitle
                    </p>
                </div>
            </div>
        </div>
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                <p>
                    Planned project end date                           &nbsp;&nbsp;<strong> @plannedProjectEndDate </strong>
                </p>
            </div>
        </div>
        <br />
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds" error-class-for="ActualClosureDate.Date">
                <p> Actual project closure date  </p>
                @Html.ValidationMessage("ActualClosureDate.Date", new { @class = "govuk-error-message" })
                <fieldset class="govuk-fieldset">
                    <rsp-gds-date-input asp-for="ActualClosureDate"
                                        day-name="ActualClosureDate.Day"
                                        day-value="@Model.ActualClosureDate?.Day"
                                        month-name="ActualClosureDate.Month"
                                        month-value="@Model.ActualClosureDate?.Month"
                                        year-name="ActualClosureDate.Year"
                                        year-value="@Model.ActualClosureDate?.Year"
                                        hint-html="For example, 28 February 2023" error-key="ActualClosureDate_Date" id="ActualClosureDate_Date"
                                        label-html-class="font-weight-none" />
                </fieldset>
            </div>
        </div>
        <br />
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                <p>
                    <strong>@Html.Raw(headline?.Value)</strong>
                </p>
            </div>
        </div>
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                <p>
                    @Html.Raw(body?.Value)
                </p>
            </div>
        </div>

        <div class="govuk-grid-row" permission="@Permissions.MyResearch.ProjectRecord_Close">
            <div class="govuk-grid-column-two-thirds">
                <div class="save-buttons">
                    <button class="govuk-button" data-module="govuk-button" type="submit" asp-route="app:confirmprojectclosure">Send to sponsor</button>
                </div>
            </div>
        </div>
    </form>
</div>