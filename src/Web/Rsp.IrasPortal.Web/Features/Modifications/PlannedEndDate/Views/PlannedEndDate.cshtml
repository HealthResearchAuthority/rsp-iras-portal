@using System.Globalization;
@using System.Text.Json
@using Rsp.IrasPortal.Application.Constants
@using Rsp.IrasPortal.Application.DTOs
@using Rsp.IrasPortal.Web.Models
@using Rsp.IrasPortal.Web.Extensions
@model QuestionnaireViewModel

@{
    var errorSummaryTitle = "There is a problem";

    var modification = TempData.PopulateBaseProjectModificationProperties(new BaseProjectModificationViewModel());

    var specificArea = modification.SpecificAreaOfChange;

    var prefix = ViewData.ModelState.IsValid ? "" : "Error - ";

    ViewBag.Title = !string.IsNullOrWhiteSpace(specificArea) ?
            $"{prefix}{specificArea}" :
            $"{prefix}{Model.Questions.FirstOrDefault()?.Section}";

    var navigation = JsonSerializer.Deserialize<NavigationDto>((TempData.Peek(TempDataKeys.ProjectModificationChange.Navigation) as string)!);

    var isReviewInProgress = TempData.Peek(TempDataKeys.ProjectModificationChange.ReviewChanges) is true;

}

<div class="govuk-width-container">
    @section BackNavigation {
        @*<partial name="_BackNavigation" model="navModel" />*@
        <vc:back-navigation navigation-dto="@navigation"
                            specific-area-of-change-id="@modification.SpecificAreaOfChangeId"
                            project-record-id="@modification.ProjectRecordId"
                            review-in-progress="@isReviewInProgress" />
    }

    <partial name="_ValidationSummary" model="(ViewData.ModelState, errorSummaryTitle)" />

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">

            <h1 class="govuk-heading-l">@specificArea</h1>

            <form method="post">

                @*<partial name="_ProjectModificationSummary" />*@

                @{
                    // show current project planned end date if exists
                    var originalQuestionId = Model.Questions.FirstOrDefault(q => q.ShowOriginalAnswer)?.QuestionId;

                    var currentPlannedEndDate = string.Empty;

                    if (originalQuestionId != null && Model.OriginalAnswers.ContainsKey(originalQuestionId))
                    {
                        var answer = Model.OriginalAnswers[originalQuestionId];

                        if (!string.IsNullOrEmpty(answer.AnswerText))
                        {
                            if (DateTime.TryParseExact(@answer.AnswerText, "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.None, out var date))
                            {
                                currentPlannedEndDate = date.ToString("dd MMMM yyyy");
                            }
                        }
                    }

                    <div class="govuk-!-margin-bottom-3 flex-gap-2">
                        <span class="govuk-label">Current planned project end date</span>
                        <span class="govuk-body govuk-!-font-weight-bold">@currentPlannedEndDate</span>
                    </div>
                }

                <partial name="_Questionnaire" model="Model" />

                <div class="save-buttons">

                    @{
                        var buttonText = isReviewInProgress ? "Save changes" : "Save and continue";
                    }

                    <partial name="_SubmitButton" model="@("pmc:saveresponses", buttonText, new Dictionary<string, string>())" />

                    @if (!isReviewInProgress)
                    {
                        ViewBag.Style = "govuk-button govuk-button--secondary";

                        <partial name="_SubmitButton" model="@("pmc:saveresponses", "Save for later", new Dictionary<string, string> {{ "saveForLater", bool.TrueString }})" />
                    }
                </div>

                <p>
                    <a href="#" class="govuk-link">Remove this change</a>
                </p>
            </form>
        </div>
    </div>
</div>