@using Rsp.Portal.Application.Constants
@model Rsp.Portal.Web.Features.Modifications.Models.ModificationDetailsViewModel


@{
    var isBackStageUser =
        User.IsInRole(Roles.SystemAdministrator)
        || User.IsInRole(Roles.StudyWideReviewer)
        || User.IsInRole(Roles.WorkflowCoordinator)
        || User.IsInRole(Roles.TeamManager);

    // get actual query parameters
    var baseRouteParams = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
    foreach (var kv in ViewContext.RouteData.Values)
    {
        baseRouteParams[kv.Key] = kv.Value?.ToString() ?? string.Empty;
    }
    foreach (var kv in Context.Request.Query)
    {
        baseRouteParams[kv.Key] = kv.Value.ToString();
    }


    var isOutcomeValid = Model.Status is
        ModificationStatus.Approved or
        ModificationStatus.NotApproved or
        ModificationStatus.NotAuthorised;


    var isCommentVisible = isBackStageUser && !string.IsNullOrWhiteSpace(Model?.ReviewerComments);

    // get activeTabId from query param if provided
    var requestedTab = Context.Request.Query["activeTabId"].ToString();

    if (requestedTab == ModificationOverview.Comments && !isCommentVisible)
    {
        Context.Response.Redirect("error/forbidden");
        return;
    }

    // default tab when query string not provided
    var queryDocuments = Context.Request.Query["documents"].ToString();
    bool isNotOnlyApplicant = User.IsInRole(Roles.Sponsor)
                                || User.IsInRole(Roles.StudyWideReviewer)
                                || User.IsInRole(Roles.TeamManager)
                                || User.IsInRole(Roles.SystemAdministrator)
                                || User.IsInRole(Roles.OrganisationAdministrator)
                                || User.IsInRole(Roles.WorkflowCoordinator);

    string defaultTab =
        queryDocuments == ModificationOverview.Documents ? ModificationOverview.Documents :
        isNotOnlyApplicant ? ModificationOverview.SponsorDetails : ModificationOverview.ModificationDetails;

    // set active tab id
    var allowedTabs = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
    {
        ModificationOverview.SponsorDetails,
        ModificationOverview.ModificationDetails,
        ModificationOverview.Documents,
        ModificationOverview.History,
        ModificationOverview.Comments
    };

    var activeTabId = (allowedTabs.Contains(requestedTab) ? requestedTab : defaultTab);
    baseRouteParams.Remove("activeTabId");

}

<!-- Keep the same GOV.UK Service Navigation look -->
<div class="govuk-service-navigation govuk-!-margin-bottom-4">
    <div class="govuk-width-container">
        <div class="govuk-service-navigation__container white-bg">
            <nav class="govuk-service-navigation__wrapper">
                <ul class="govuk-service-navigation__list">

                    <li class="govuk-service-navigation__item small-margin @(activeTabId == ModificationOverview.SponsorDetails ? "govuk-service-navigation__item--active" : "")">
                        <a class="govuk-service-navigation__link"
                           asp-route=""
                           asp-all-route-data="baseRouteParams"
                           asp-route-activeTabId="@ModificationOverview.SponsorDetails"
                           data-tab="@ModificationOverview.SponsorDetails">
                            @ModificationOverview.SponsorDetails
                        </a>
                    </li>

                    <li class="govuk-service-navigation__item small-margin @(activeTabId == ModificationOverview.ModificationDetails ? "govuk-service-navigation__item--active" : "")">
                        <a class="govuk-service-navigation__link"
                           asp-route=""
                           asp-all-route-data="baseRouteParams"
                           asp-route-activeTabId="@ModificationOverview.ModificationDetails"
                           data-tab="@ModificationOverview.ModificationDetails">
                            @ModificationOverview.ModificationDetails
                        </a>
                    </li>

                    <li class="govuk-service-navigation__item small-margin @(activeTabId == ModificationOverview.Documents ? "govuk-service-navigation__item--active" : "")">
                        <a class="govuk-service-navigation__link"
                           asp-route=""
                           asp-all-route-data="baseRouteParams"
                           asp-route-activeTabId="@ModificationOverview.Documents"
                           data-tab="@ModificationOverview.Documents">
                            @ModificationOverview.Documents
                        </a>
                    </li>

                    <li class="govuk-service-navigation__item small-margin @(activeTabId == ModificationOverview.History ? "govuk-service-navigation__item--active" : "")">
                        <a class="govuk-service-navigation__link"
                           asp-route=""
                           asp-all-route-data="baseRouteParams"
                           asp-route-activeTabId="@ModificationOverview.History"
                           data-tab="@ModificationOverview.History">
                            @ModificationOverview.History
                        </a>
                    </li>

                    @if (isCommentVisible && isOutcomeValid)
                    {
                        <li class="govuk-service-navigation__item small-margin @(activeTabId == ModificationOverview.Comments ? "govuk-service-navigation__item--active" : "")">
                            <a class="govuk-service-navigation__link"
                               asp-route=""
                               asp-all-route-data="baseRouteParams"
                               asp-route-activeTabId="@ModificationOverview.Comments"
                               data-tab="@ModificationOverview.Comments">
                                @ModificationOverview.Comments
                            </a>
                        </li>
                    }
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Panels (toggle visibility) -->
<div id="tab-content-root">
    @switch (activeTabId)
    {
        case ModificationOverview.SponsorDetails:
            <partial name="SponsorDetails" model="Model" viewData="ViewData" />
            break;
        case ModificationOverview.ModificationDetails:
            <partial name="ModificationChanges" model="Model" viewData="ViewData" />
            break;
        case ModificationOverview.Documents:
            <partial name="SupportingDocuments" model="Model" viewData="ViewData" />
            break;
        case ModificationOverview.History:
            <partial name="_ProjectModificationAuditTrail" model="Model.AuditTrailModel" viewData="ViewData" />
            break;
        case ModificationOverview.Comments:
            if (isCommentVisible && isOutcomeValid)
            {
                <partial name="ReviewerComments" model="Model" viewData="ViewData" />
            }
            break;
    }
</div>

<!-- Load tab panels without reloading page for JS Enabled users -->
<script src="~/js/navigationTabPartial.js" asp-append-version="true" defer></script>