@using System.Globalization
@using System.Text.Json
@using Microsoft.AspNetCore.Mvc.ModelBinding
@using Microsoft.AspNetCore.Http.Extensions
@using Microsoft.FeatureManagement
@using Rsp.IrasPortal.Application.Constants
@using Rsp.IrasPortal.Application.DTOs
@using Rsp.IrasPortal.Web.Features.Modifications.Models
@model ModificationDetailsViewModel

@{

	ViewBag.Title = "Review all changes";

	TempData[TempDataKeys.ProjectModification.ReviewAllChanges] = true;

	ViewData[ViewDataKeys.ShowRemoveLink] = false;
	ViewData[ViewDataKeys.ShowModificationChangeStatus] = false;
	ViewData[ViewDataKeys.ShowModificationStatus] = true;

}

@section BackNavigation {

	@* if we have a urlReferrer use that for back navigation *@
	@{
		// set this TempData key to true on the referrer page like PostApprovals
		// or any other BackStage or FrontStage page so that we can link back to that page.
		// If this Key is not set, the Back link won't be displayed
		var linkBackToReferrer = TempData[TempDataKeys.ProjectModification.LinkBackToReferrer];
		var urlReferrer = TempData[TempDataKeys.ProjectModification.UrlReferrer];

		if (linkBackToReferrer is true && urlReferrer is not null)
		{
			ViewData[ViewDataKeys.UrlReferrer] = urlReferrer;

			// no route for back navigation, as this page will
			// only show back button when you are navigating from some other url
			// given the LinkBackToReferrer is set
			<partial name="_BackNavigation" model="@("", "Back", new Dictionary<string, string>())" />
		}
	}
	@*<partial name="_BackNavigation" model="@("pmc:sponsorreference", "Back", new Dictionary<string, string>() { { "projectRecordId", Model.ProjectRecordId } })" />*@
}

<div class="govuk-grid-row">
	<div class="govuk-grid-column-two-thirds">

        <authorized auth-params="@new(Roles: "applicant,sponsor")">
            @if (Model.Status is ModificationStatus.Approved || Model.Status is ModificationStatus.NotApproved || Model.Status is ModificationStatus.WithReviewBody)
            {
                <h1 class="govuk-heading-l">Modification</h1>
            }
            else
            {
                <h1 class="govuk-heading-l">Review all changes</h1>
            }
        </authorized>

		@{
			<partial name="_ProjectModificationSummary" model="Model" viewData="ViewData" />
		}
		<h2 class="govuk-heading-m">Overall modification ranking</h2>
		<div class="govuk-summary-card">
			<div class="govuk-summary-card__title-wrapper">
				<h2 class="govuk-summary-card__title">
					Ranking
				</h2>
			</div>
			<div class="govuk-summary-card__content">
				<div class="govuk-summary-card__content">
					@{
						var ranking = new RankingOfChangeViewModel
			{
				ModificationType = Model.ModificationType,
				Category = Model.Category,
				ReviewType = Model.ReviewType
			};

						<partial name="RankingOfChange" model="ranking" />
					}
				</div>
			</div>
		</div>
	</div>
</div>
<div class="govuk-grid-row">
	<div class="govuk-grid-column-full">
		<authorized auth-params="@new(Roles: "applicant,sponsor")">
			@if (Model.Status is ModificationStatus.Approved || Model.Status is ModificationStatus.NotApproved || Model.Status is ModificationStatus.WithReviewBody)
			{
				<partial name="_NavigationTabPartial" model="Model" view-data="ViewData" />
			}
			else
			{
				<h2 class="govuk-heading-m">Changes</h2>
				<partial name="ModificationChanges" model="Model" view-data="ViewData" />

				<div class="govuk-grid-row">
					<div class="govuk-grid-column-full">
						<h2 class="govuk-heading-m">Supporting documents</h2>
						<div class="govuk-grid-row">
							<div class="govuk-grid-column-full">
								<authorized auth-params="@new(Roles:"applicant,system_administrator,reviewer")">
									<div class="govuk-table-wrapper">
										<form method="get" id="projectdocuments-selection">
											<table class="govuk-table modifications-tasklist-table" id="projectDocumentsTable">
												<thead class="govuk-table__head">
													<tr class="govuk-table__row govuk-table__header-sortable govuk-body-s">
														@{
															var sortableHeaders = new[]
															{
															new { Field = nameof(ProjectOverviewDocumentDto.DocumentType), Label = "Document type" },
															new { Field = nameof(ProjectOverviewDocumentDto.DocumentName), Label = "Document name" },
															new { Field = nameof(ProjectOverviewDocumentDto.FileName), Label = "File name" },
															new { Field = nameof(ProjectOverviewDocumentDto.DocumentVersion), Label = "Version" },
															new { Field = nameof(ProjectOverviewDocumentDto.DocumentDate), Label = "Document date" },
															new { Field = nameof(ProjectOverviewDocumentDto.Status), Label = "Status" }
															};
															var tableId = "projectDocumentsTable";
														}

														@foreach (var header in sortableHeaders)
														{
															var displayText = header.Label.Contains(" ")
															? header.Label.Replace(" ", "<br />")
															: header.Label;

															<th scope="col" class="govuk-table__header govuk-table__header-sortable">
																@await Html.PartialAsync("_SortableHeaderButton", new SortableHeaderModel
																 {
																	 FieldName = header.Field,
																	 DisplayText = displayText,
																	 CurrentSortField = Model.ProjectOverviewDocumentViewModel.Pagination?.SortField,
																	 CurrentSortDirection = Model.ProjectOverviewDocumentViewModel.Pagination?.SortDirection,
																	 TableId = tableId,
																	 AdditionalParameters = new Dictionary<string, string>
																		{
																			{ "projectRecordId", Model.ProjectRecordId },
																			{ "irasId", Model.IrasId },
																			{ "shortTitle", Model.ShortTitle! },
																			{ "projectModificationId", Model.ModificationId }
																		}
																 })
															</th>
														}
														<th scope="col" class="govuk-table__header">Action</th>
													</tr>
												</thead>
												<tbody class="govuk-table__body govuk-body-s">
													@foreach (var modification in Model.ProjectOverviewDocumentViewModel?.Documents ?? Enumerable.Empty<ProjectOverviewDocumentDto>())
													{
														var isFailed = string.Equals(modification.Status, DocumentStatus.Failed, StringComparison.OrdinalIgnoreCase);

														<tr class="govuk-table__row">
															<td class="govuk-table__cell">
																<span class="govuk-!-font-weight-bold">@modification.DocumentType</span>
																@if (isFailed)
																{
																	<div class="govuk-error-message govuk-!-margin-top-1 govuk-!-margin-bottom-1">
																		The selected file contains a virus
																	</div>
																	<form asp-route="pmc:confirmdeletedocument"
																		  asp-route-id="@modification.Id"
																		  asp-route-backRoute="toaddpage"
																		  method="get"
																		  class="govuk-!-margin-bottom-0">
																		<input type="hidden" name="id" value="@modification.Id" />
																		<button type="submit" class="govuk-button govuk-button--warning govuk-!-margin-bottom-0">
																			Delete
																		</button>
																	</form>
																}
															</td>
															<td class="govuk-table__cell">@modification.DocumentName</td>
															<td class="govuk-table__cell">
																@if (modification.Status == DocumentStatus.Success)
																{
																	<a asp-route="pmc:downloaddocument"
																	   asp-route-fileName="@modification.FileName"
																	   asp-route-path="@modification.DocumentStoragePath"
																	   class="govuk-link">
																		@modification.FileName
																	</a>
																}
																else
																{
																	@modification.FileName
																}
															</td>
															<td class="govuk-table__cell">@modification.DocumentVersion</td>
															<td class="govuk-table__cell">@modification.DocumentDate?.ToString("d MMM yyyy")</td>
															<td class="govuk-table__cell">
																<strong class="govuk-tag @(isFailed ? "govuk-tag--red" : "govuk-tag--green")">
																	@modification.Status
																</strong>
															</td>
															<td class="govuk-table__cell">
																@if (!isFailed)
																{
																	<a asp-route="pmc:continuetodetails"
																	   asp-route-documentId="@modification.Id"
																	   asp-route-reviewAllChanges="true"
																	   class="govuk-link">
																		Change details
																	</a>
																}
															</td>
														</tr>
													}
												</tbody>

											</table>
										</form>
									</div>
									<partial name="_Pagination" model="@Model.ProjectOverviewDocumentViewModel?.Pagination" />
								</authorized>
							</div>
						</div>
					</div>
				</div>
				<div class="govuk-button-group">
					<form method="get">
						@{
							ViewBag.Style = "govuk-button govuk-button--secondary";
						}
						<partial name="_SubmitButton" model="@("pmc:projectdocument", "Add documents", new Dictionary<string, string> { })" />
					</form>
				</div>
				<partial name="SponsorDetails" model="Model" view-data="ViewData" />
			}
		</authorized>
	</div>
</div>

<authorized auth-params="@new(Roles: "applicant")">
	@if (Model.Status is ModificationStatus.InDraft)
	{
		<div class="govuk-grid-row">
			<div class="govuk-grid-column-two-thirds">
				<h2 class="govuk-heading-m">Now send to sponsor</h2>
				<p class="govuk-body">
					By sending this modification you are confirming that, to the best of your knowledge, the details you are providing are correct.
				</p>
				<form method="post">
					<div class="save-buttons">
						@{
							<input type="hidden" name="projectRecordId" value="@Model.ProjectRecordId" />
							<partial name="_SubmitButton" model="@("pmc:sendmodificationtosponsor", "Send modification to sponsor", new Dictionary<string, string>()
                                                             {
                                                                 ["projectModificationId"] = Model.ModificationId!,
                                                                 ["projectRecordId"] = Model.ProjectRecordId
                                                             })" />

							ViewBag.Style = "govuk-button govuk-button--secondary";

							<partial name="_SubmitButton" model="@("pmc:saveforlater", "Save for later", new Dictionary<string, string> { ["projectRecordId"] = Model.ProjectRecordId, ["routeName"] = "pov:postapproval" })" />
						}
					</div>
				</form>
				<a asp-route="pmc:deletemodification"
				   asp-route-projectRecordId="@Model.ProjectRecordId"
				   asp-route-irasId="@(Model.ModificationIdentifier?.Split('/')[0])"
				   asp-route-shortTitle="@Model.ShortTitle"
				   asp-route-projectModificationId="@Model.ModificationId"
				   class="govuk-link">
					Delete modification
				</a>
			</div>
		</div>
	}
</authorized>