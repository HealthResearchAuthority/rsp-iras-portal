@using System.Globalization
@using System.Text.Json
@using Microsoft.AspNetCore.Mvc.ModelBinding
@using Microsoft.AspNetCore.Http.Extensions
@using Microsoft.FeatureManagement
@using Rsp.IrasPortal.Application.Constants
@using Rsp.IrasPortal.Web.Features.Modifications.Models
@model ModificationDetailsViewModel

@{
    ViewBag.Title = "Review all changes";

    TempData[TempDataKeys.ProjectModification.ReviewAllChanges] = true;

    ViewData[ViewDataKeys.ShowRemoveLink] = false;
    ViewData[ViewDataKeys.ShowModificationChangeStatus] = false;
    ViewData[ViewDataKeys.ShowModificationStatus] = true;

}

@section BackNavigation {

    @* if we have a urlReferrer use that for back navigation *@
    @{
        // set this TempData key to true on the referrer page like PostApprovals
        // or any other BackStage or FrontStage page so that we can link back to that page.
        // If this Key is not set, the Back link won't be displayed
        var linkBackToReferrer = TempData[TempDataKeys.ProjectModification.LinkBackToReferrer];
        var urlReferrer = TempData[TempDataKeys.ProjectModification.UrlReferrer];

        if (linkBackToReferrer is true && urlReferrer is not null)
        {
            ViewData[ViewDataKeys.UrlReferrer] = urlReferrer;

            // no route for back navigation, as this page will
            // only show back button when you are navigating from some other url
            // given the LinkBackToReferrer is set
            <partial name="_BackNavigation" model="@("", "Back", new Dictionary<string, string>())" />
        }
    }
    @*<partial name="_BackNavigation" model="@("pmc:sponsorreference", "Back", new Dictionary<string, string>() { { "projectRecordId", Model.ProjectRecordId } })" />*@
}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
        <h1 class="govuk-heading-l">Review all changes</h1>

        @{
            <partial name="_ProjectModificationSummary" model="Model" viewData="ViewData" />
        }
        <h2 class="govuk-heading-m">Overall modification ranking</h2>
        <div class="govuk-summary-card">
            <div class="govuk-summary-card__title-wrapper">
                <h2 class="govuk-summary-card__title">
                    Ranking
                </h2>
            </div>
            <div class="govuk-summary-card__content">
                <div class="govuk-summary-card__content">
                    <partial name="RankingOfChange" />
                </div>
            </div>
        </div>
    </div>
</div>
<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">

        <h2 class="govuk-heading-m">Changes</h2>

        <partial name="ModificationChanges" model="Model" view-data="ViewData" />

        <h2 class="govuk-heading-m">Sponsor details</h2>

        <div class="govuk-summary-card">
            <div class="govuk-summary-card__title-wrapper">
                <h2 class="govuk-summary-card__title">
                    Sponsor details
                </h2>
                @if (Model.Status is ModificationStatus.Draft)
                {
                    <ul class="govuk-summary-card__actions">
                        <li class="govuk-summary-card__action">
                            <a class="govuk-link" asp-route="pmc:sponsorreference" asp-route-projectRecordId="@Model.ProjectRecordId">Change</a>
                        </li>
                    </ul>
                }
            </div>
            <div class="govuk-summary-card__content">
                <dl class="govuk-summary-list">

                    @foreach (var question in Model.SponsorDetails)
                    {
                        <div class="govuk-summary-list__row">
                            <dt class="govuk-summary-list__key">
                                @question.ShortQuestionText
                            </dt>
                            <dd class="govuk-summary-list__value">
                                @question.GetDisplayText(false)
                            </dd>
                        </div>
                    }
                </dl>
            </div>
        </div>
    </div>
</div>

@if (Model.Status is ModificationStatus.Draft)
{
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            <h2 class="govuk-heading-m">Now send to sponsor</h2>
            <p class="govuk-body">
                By sending this modification you are confirming that, to the best of your knowledge, the details you are providing are correct.
            </p>
            <form method="post">
                <div class="save-buttons">
                    @{
                        <input type="hidden" name="projectRecordId" value="@Model.ProjectRecordId" />
                        <partial name="_SubmitButton" model="@("pmc:sendmodificationtosponsor", "Send modification to sponsor", new Dictionary<string, string>()
                                                             {
                                                                 ["projectModificationId"] = Model.ModificationId!,
                                                                 ["projectRecordId"] = Model.ProjectRecordId
                                                             })" />

                        ViewBag.Style = "govuk-button govuk-button--secondary";

                        <partial name="_SubmitButton" model="@("pov:postapproval", "Save for later", new Dictionary<string, string> { ["projectRecordId"] = Model.ProjectRecordId })" />
                    }
                </div>
            </form>
			<a asp-route="pmc:deletemodification"
			   asp-route-projectRecordId="@Model.ProjectRecordId"
			   asp-route-irasId="@(Model.ModificationIdentifier?.Split('/')[0])"
			   asp-route-shortTitle="@Model.ShortTitle"
			   asp-route-projectModificationId="@Model.ModificationId"
               class="govuk-link">
                Delete modification
            </a>
        </div>
    </div>
}