@using System.Globalization
@using System.Text.Json
@using Microsoft.AspNetCore.Mvc.ModelBinding
@using Microsoft.AspNetCore.Http.Extensions
@using Microsoft.FeatureManagement
@using Rsp.IrasPortal.Application.Constants
@using Rsp.IrasPortal.Application.DTOs
@using Rsp.IrasPortal.Web.Features.Modifications.Models
@model ModificationDetailsViewModel

@{

    ViewBag.Title = "Review all changes";

    TempData[TempDataKeys.ProjectModification.ReviewAllChanges] = true;
    ViewData[ViewDataKeys.ShowRemoveLink] = false;
    ViewData[ViewDataKeys.ShowModificationChangeStatus] = false;
    ViewData[ViewDataKeys.ShowModificationStatus] = true;
    var projectTitle = !string.IsNullOrEmpty(Model.ShortTitle) ? Model.ShortTitle : "Project overview";
    var linkBackToReferrer = TempData[TempDataKeys.ProjectModification.LinkBackToReferrer];
    var urlReferrer = TempData[TempDataKeys.ProjectModification.UrlReferrer];
    var urlSegments = urlReferrer?.ToString()!.Split('/', StringSplitOptions.RemoveEmptyEntries);
    var previousController = string.Empty;
    // Assuming URL pattern: /Controller/Action
    if (urlSegments?.Length > 0)
    {
        previousController = urlSegments[2]; // This is usually the controller
    }
}

@if (Model.Status != ModificationStatus.InDraft && !(previousController is ApprovalsSearch.ControllerName or ModificationsTasklist.ControllerName))
{
    <authorized auth-params="@new(Roles: "applicant")">

        @section Breadcrumb {

            @await Html.PartialAsync("_Breadcrumb", new List<(string, string?)>
            {
                ("My research",Url.RouteUrl("app:welcome")),
                (projectTitle, Url.RouteUrl("pov:postapproval", new Dictionary<string, string>{{"projectRecordId", Model.ProjectRecordId!}}))
            })
        }
    </authorized>
}
else
{
    @section BackNavigation {

        @{
            // set this TempData key to true on the referrer page like PostApprovals
            // or any other BackStage or FrontStage page so that we can link back to that page.
            // If this Key is not set, the Back link won't be displayed
            if (linkBackToReferrer is true && urlReferrer is not null)
            {
                ViewData[ViewDataKeys.UrlReferrer] = urlReferrer;

                // no route for back navigation, as this page will
                // only show back button when you are navigating from some other url
                // given the LinkBackToReferrer is set
                <partial name="_BackNavigation" model="@("", "Back", new Dictionary<string, string>())" />
            }
        }
    }
}

<partial name="_ReviewModification" model="Model" />

<authorized auth-params="@new(Roles: "applicant")">
    @if (Model.Status is ModificationStatus.InDraft)
    {
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                <h2 class="govuk-heading-m">Now send to sponsor</h2>
                <p class="govuk-body">
                    By sending this modification you are confirming that, to the best of your knowledge, the details you are providing are correct.
                </p>
                <form method="post">
                    <div class="save-buttons">
                        @{
                            <input type="hidden" name="projectRecordId" value="@Model.ProjectRecordId" />
                            <partial name="_SubmitButton" model="@("pmc:sendmodificationtosponsor", "Send modification to sponsor", new Dictionary<string, string>()
                                    {
                                        ["projectModificationId"] = Model.ModificationId!,
                                        ["projectRecordId"] = Model.ProjectRecordId
                                    })" />

                            ViewBag.Style = "govuk-button govuk-button--secondary";

                            <partial name="_SubmitButton" model="@("pmc:saveforlater", "Save for later", new Dictionary<string, string> { ["projectRecordId"] = Model.ProjectRecordId, ["routeName"] = "pov:postapproval" })" />
                        }
                    </div>
                </form>
                <a asp-route="pmc:deletemodification"
                   asp-route-projectRecordId="@Model.ProjectRecordId"
                   asp-route-irasId="@(Model.ModificationIdentifier?.Split('/')[0])"
                   asp-route-shortTitle="@Model.ShortTitle"
                   asp-route-projectModificationId="@Model.ModificationId"
                   class="govuk-link">
                    Delete modification
                </a>
            </div>
        </div>
    }
</authorized>

<authorized auth-params="@new(Roles: "system_administrator,study-wide_reviewer,team_manager,workflow_co-ordinator" )">
    @if (Model.Status == ModificationStatus.WithReviewBody)
    {
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                <div class="govuk-heading-m">
                    Next steps
                </div>
                <div class="govuk-body">
                    When you've completed your review of all the information on this page,
                    continue to the next step where you'll enter the review outcome
                </div>
                <a asp-route="pmc:reviewoutcome"
                   class="govuk-button">
                    Continue
                </a>
            </div>
        </div>
    }
</authorized>