@using Rsp.IrasPortal.Application.Constants
@using Rsp.IrasPortal.Web.Features.Modifications.Models
@model ModificationDetailsViewModel

@{
    var showStatus = ViewData[ViewDataKeys.ShowModificationChangeStatus];
    var showChangeLink = ViewData[ViewDataKeys.ShowChangeLink];
    var showRemoveLink = ViewData[ViewDataKeys.ShowRemoveLink];
}

@foreach (var (change, changeIndex) in Model.ModificationChanges.Select((change, changeIndex) => (change, changeIndex)))
{
    <div class="govuk-summary-card">
        <div class="govuk-summary-card__title-wrapper prevent-action-stretch">
            <h2 class="govuk-summary-card__title">
                Change @(changeIndex + 1) - @change.AreaOfChangeName<br />

                @if (showStatus is null or true && Model.Status is "Draft")
                {
                    <strong class="govuk-!-margin-top-2 text-nowrap govuk-tag @(change.ChangeStatus == "Unfinished" ? "govuk-tag--red" : "govuk-tag--green") non-max-width-govuk-tag">
                        @change.ChangeStatus
                    </strong>
                }
            </h2>
            <ul class="govuk-summary-card__actions">
                @if (showChangeLink is null or true && Model.Status is "Draft")
                {
                    <li class="govuk-summary-card__action">

                        @{
                            var reviewChangesParams = new Dictionary<string, string> {
                                    { "projectRecordId", Model.ProjectRecordId },
                                    { "specificAreaOfChangeId", change.SpecificAreaOfChangeId },
                                    { "modificationChangeId", change.ModificationChangeId.ToString() },
                                    { "reviseChange", bool.TrueString },
                                };

                            <a class="govuk-link" asp-route="pmc:reviewchanges" asp-all-route-data="reviewChangesParams">Change</a>
                        }
                    </li>
                }

                @if (showRemoveLink is null or true && Model.Status is "Draft")
                {
                    <li class="govuk-summary-card__action">
                        <a class="govuk-link"
                           asp-route="pmc:confirmremovechange"
                           asp-route-modificationChangeId="@change.ModificationChangeId"
                           asp-route-modificationChangeName="@change.SpecificChangeName">
                            Remove
                        </a>
                    </li>
                }
            </ul>
        </div>
        <div class="govuk-summary-card__content">
            <dl class="govuk-summary-list">
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key">
                        @change.SpecificChangeName
                    </dt>
                    <dd class="govuk-summary-list__value">
                        @change.SpecificChangeAnswer
                    </dd>
                </div>
                @foreach (var question in change.Questions)
                {
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            @(string.IsNullOrWhiteSpace(question.ShortQuestionText) ? question.ShortQuestionText : question.QuestionText)
                        </dt>
                        <dd class="govuk-summary-list__value">
                            @question.GetDisplayText(false)
                        </dd>
                    </div>
                }
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key">
                        Modification type
                    </dt>
                    <dd class="govuk-summary-list__value">
                        @change.ModificationType.Substantiality
                    </dd>
                </div>
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key">
                        Category
                    </dt>
                    <dd class="govuk-summary-list__value">
                        @change.Categorisation.Category
                    </dd>
                </div>
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key">
                        Review type
                    </dt>
                    <dd class="govuk-summary-list__value">
                        @change.ReviewType
                    </dd>
                </div>
            </dl>
        </div>
    </div>
}