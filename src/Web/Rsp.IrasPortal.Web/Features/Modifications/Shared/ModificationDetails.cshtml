@using System.Globalization
@using System.Text.Json
@using Microsoft.AspNetCore.Mvc.ModelBinding
@using Microsoft.FeatureManagement
@using Rsp.Portal.Application.Constants
@using Rsp.Portal.Application.DTOs.Responses.CmsContent;
@using Rsp.Portal.Domain.AccessControl
@using Rsp.Portal.Web.Features.Modifications.Models
@using Rsp.Portal.Web.Models
@model ModificationDetailsViewModel

@{

	ViewBag.Title = (string?)ViewData[PageContentElements.MetaTitle];

    var isAuthoriser = TempData[TempDataKeys.IsAuthoriser] as bool? ?? false;
    var isRevisionBySponsor = false;

    <authorized permission="@Permissions.Sponsor.Modifications_Authorise"
                status-for="Status"
                status-is="@ModificationStatus.ReviseAndAuthorise">
        @{
            isRevisionBySponsor = isAuthoriser;
            ViewBag.Title = "Revise and authorise";
            ViewBag.IsRevisionBySponsor = true;
        }
    </authorized>
}

@section BackNavigation {

    @* if we have a urlReferrer use that for back navigation *@
    @{
        // set this TempData key to true on the referrer page like PostApprovals
        // or any other BackStage or FrontStage page so that we can link back to that page.
        // If this Key is not set, the Back link won't be displayed
        var linkBackToReferrer = TempData[TempDataKeys.ProjectModification.LinkBackToReferrer];
        var urlReferrer = TempData[TempDataKeys.ProjectModification.UrlReferrer];

        if (linkBackToReferrer is true && urlReferrer is not null && !isRevisionBySponsor)
        {
            ViewData[ViewDataKeys.UrlReferrer] = urlReferrer;

            // no route for back navigation, as this page will
            // only show back button when you are navigating from some other url
            // given the LinkBackToReferrer is set
            <partial name="_BackNavigation" model="@("", "Back", new Dictionary<string, string>())" />
        }
    }
}

@{
    // display the notification banner if change is removed
    var changeRemoved = TempData[TempDataKeys.ProjectModificationChange.ChangeRemoved];
    var changeName = TempData[TempDataKeys.ProjectModificationChange.ChangeName];

    if (changeRemoved is true)
    {
        <partial name="_NotificationBanner"
                 model="@(new NotificationBannerModel
                        {
                            Title = "Success",
                            Heading = $"{changeName} has been removed"
                        })" />

    }

    var pageContentData = (Dictionary<string, MixedContentPageItem?>?)ViewData[PageContentElements.PageContent];
    var pageContent = pageContentData != null ?
        pageContentData :
        new Dictionary<string, MixedContentPageItem?>();

    var maxChangesWarning = pageContent.GetValueOrDefault("ModificationDetails.MaxChangesWarning", null);
    var headline = pageContent.GetValueOrDefault("ModificationDetails.RevisionDescriptionHeadline", null);
    var description = pageContent.GetValueOrDefault("ModificationDetails.RevisionDescriptionBody", null);
}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">

        @if (isRevisionBySponsor)
        {
            <h1 class="govuk-heading-l">Revise and authorise</h1>
            <partial name="_ValidationSummary" model="@(ViewData.ModelState, "There is a problem")" />
        }
        else
        {
            <h1 class="govuk-heading-l">Modification details</h1>
        }

        @{
            ViewData[ViewDataKeys.ShowModificationStatus] = true;
            <partial name="_ProjectModificationSummary" model="Model" view-data="ViewData" />
        }

        @* Only show the Overall ranking if we have the changes *@
        @if (Model.ModificationChanges.Any())
        {
            <h2 class="govuk-heading-m">Summary details</h2>
            <div class="govuk-summary-card">
                <div class="govuk-summary-card__title-wrapper">
                    <h2 class="govuk-summary-card__title">
                        Ranking
                    </h2>
                </div>
                <div class="govuk-summary-card__content">
                    @{
                        var ranking = new RankingOfChangeViewModel
                        {
                            ModificationType = Model.ModificationType,
                            Category = Model.Category,
                            ReviewType = Model.ReviewType
                        };

                        <partial name="RankingOfChange" model="ranking" />
                    }
                </div>
            </div>
        }
    </div>
</div>
<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
        <h2 class="govuk-heading-m">Changes</h2>
        <partial name="ModificationChanges" model="Model" view-data="ViewData" />

        @if (Model.ModificationChanges.Count == 10)
        {
            <div class="govuk-warning-text govuk-!-margin-top-3">
                <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
                <strong class="govuk-warning-text__text">
                    <span class="govuk-visually-hidden">Warning</span>
                    @Html.Raw(maxChangesWarning?.Value)
                </strong>
            </div>
        }

        <div class="save-buttons">
            @if ((Model.Status is ModificationStatus.InDraft || isRevisionBySponsor) && Model.ModificationChanges.Count < 10)
            {
                <a asp-route="pmc:areaofchange" asp-route-projectModificationId="@Model.ModificationId" class="govuk-button govuk-button--secondary">
                    Add another change to this modification
                </a>
            }

            @if (!Model.ModificationChanges.Any() && Model.Status is ModificationStatus.InDraft)
            {
                <a asp-route="pmc:saveforlater" asp-route-projectRecordId="@Model.ProjectRecordId" asp-route-routeName="pov:postapproval" class="govuk-button govuk-button--secondary">
                    Save for later
                </a>
            }
        </div>
    </div>
</div>

<authorized role-is="@Roles.Applicant">
    @* Only show the Overall ranking if we have the changes *@
    @if (Model.ModificationChanges.Any() && Model.Status is ModificationStatus.InDraft)
    {
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                <h2 class="govuk-heading-m">Supporting documents</h2>
                <p class="govuk-body">
                    If any of the changes you're making involve an update to any project documents, make sure you add a copy of the original and updated documents.
                </p>
            </div>
        </div>
        <div class="govuk-button-group">
            <form method="get">
                @{
                    ViewBag.Style = "govuk-button govuk-button--secondary";
                }
                <partial name="_SubmitButton" model="@("pmc:projectdocument", "Add documents", new Dictionary<string, string> { })" />
            </form>
        </div>
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                <h2 class="govuk-heading-m">Add summary and review modification before sending to sponsor</h2>
                <p class="govuk-body">
                    You'll have the option to add a brief summary and edit your modification before sending it to the sponsor on the next page.
                </p>

                <div class="save-buttons">
                    <input type="hidden" name="projectRecordId" value="@Model.ProjectRecordId" />
                    @{
                        var routeName = Model.ChangesReadyForSubmission ? "pmc:sponsorreference" : "pmc:unfinishedchanges";

                        <a asp-route="@routeName" asp-route-projectRecordId="@Model.ProjectRecordId" class="govuk-button">
                            Save and continue to review
                        </a>

                        <a asp-route="pmc:saveforlater" asp-route-projectRecordId="@Model.ProjectRecordId" asp-route-routeName="pov:postapproval" class="govuk-button govuk-button--secondary">
                            Save for later
                        </a>
                    }
                </div>
            </div>
        </div>
    }

    <a status-for="Status"
       status-is="@ModificationStatus.InDraft"
       asp-route-projectRecordId="@Model.ProjectRecordId"
       asp-route-irasId="@(Model.ModificationIdentifier?.Split('/')[0])"
       asp-route-shortTitle="@Model.ShortTitle"
       asp-route-projectModificationId="@Model.ModificationId"
       asp-route="pmc:deletemodification"
       class="govuk-link">
        Delete modification
    </a>
</authorized>

<authorized permission="@Permissions.Sponsor.Modifications_Authorise"
                status-for="Status"
                status-is="@ModificationStatus.ReviseAndAuthorise">
    @if (isAuthoriser && Model.ModificationChanges.Any())
    {
        <hr aria-hidden="true" class="govuk-section-break govuk-section-break--l govuk-section-break--visible">
        @if (Model?.ProjectOverviewDocumentViewModel?.Documents is null || !Model.ProjectOverviewDocumentViewModel.Documents.Any())
        {
            <div class="govuk-grid-row">
                <div class="govuk-grid-column-two-thirds">
                    <h2 class="govuk-heading-m">Supporting documents</h2>
                    <p class="govuk-body">
                        If any of the changes you're making involve an update to any project documents, make sure you add a copy of the original and updated documents.
                    </p>
                </div>
            </div>
            <div class="govuk-button-group">
                <form method="get">
                    @{
                        ViewBag.Style = "govuk-button govuk-button--secondary";
                    }
                    <partial name="_SubmitButton" model="@("pmc:projectdocument", "Add documents", new Dictionary<string, string> { })" />
                </form>
            </div>
        }
        else
        {
            <partial name="SupportingDocuments" model="Model" view-data="ViewData" />
        }
        <hr aria-hidden="true" class="govuk-section-break govuk-section-break--l govuk-section-break--visible">
        <partial name="SponsorDetails" model="Model" view-data="ViewData" />

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                <h1 class="govuk-heading-m">
                    @Html.Raw(headline?.Value)
                </h1>
            </div>
        </div>

        <form asp-route="sws:authoriserevision" method="post">
            <div class="govuk-grid-row">
                <div class="govuk-grid-column-two-thirds">
                    @Html.Raw(description?.Value)
                    <div class="govuk-form-group govuk-character-count"
                         data-module="govuk-character-count"
                         data-maxlength="500"
                         error-class-for="RevisionDescription">

                        @Html.ValidationMessageFor(model => model.RevisionDescription, "", new { @class = "govuk-error-message" })
                        <textarea asp-for="RevisionDescription"
                                  name="RevisionDescription"
                                  class="govuk-textarea govuk-js-character-count"
                                  rows="5"
                                  aria-describedby="with-hint-info with-hint-hint">
                            </textarea>
                        <noscript>
                            <div id="RevisionDescription-info"
                                 class="govuk-hint govuk-character-count__message">
                                <p class='govuk-hint'>You can enter up to 500 characters</p>
                            </div>
                        </noscript>

                        <div id="RevisionDescription-info"
                             aria-hidden="true"
                             class="govuk-hint govuk-character-count__message">
                        </div>
                    </div>

                    <input type="hidden" name="ProjectRecordId" value="@Model.ProjectRecordId" />
                    <input type="hidden" name="ModificationId" value="@Model.ModificationId" />
                    <input type="hidden" name="SponsorOrganisationUserId" value="@Model.SponsorOrganisationUserId" />
                    <input type="hidden" name="ShortTitle" value="@Model.ShortTitle" />
                    <input type="hidden" name="IrasId" value="@Model.IrasId" />
                    <input type="hidden" name="RtsId" value="@Model.RtsId" />

                    <div class="save-buttons">
                        <button type="submit" class="govuk-button" data-module="govuk-button">
                            Authorise
                        </button>

                        <button type="submit"
                                name="isSaveForLater"
                                value="true"
                                class="govuk-button govuk-button--secondary">
                            Save for later
                        </button>
                     </div>
                </div>
            </div>
        </form>
    }
</authorized>