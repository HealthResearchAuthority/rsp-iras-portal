@using Rsp.Portal.Application.Constants
@using Rsp.Portal.Application.DTOs.Responses.CmsContent
@using Rsp.Portal.Application.Extensions
@using Rsp.Portal.Domain.AccessControl
@model Rsp.Portal.Web.Features.SponsorWorkspace.Authorisation.Models.AuthorisationsSponsorSelectorViewModel

@section Breadcrumb {
    @await Html.PartialAsync("_Breadcrumb", new List<(string, string?)>
    {
        ("Sponsor workspace", Url.RouteUrl("sws:sponsorworkspace"))
    })
}

@{
    var pageContentData = (Dictionary<string, MixedContentPageItem?>?)ViewData[PageContentElements.PageContent];
    var pageContent = pageContentData != null
        ? pageContentData
        : new Dictionary<string, MixedContentPageItem?>();

    var headline = pageContent.GetValueOrDefault("SponsorWorkspace.SponsorSelector.Headline", null);
}

@{
    var cards = Model.SponsorOrganisations
        .OrderBy(x => x.SponsorOrganisationName, StringComparer.OrdinalIgnoreCase)
        .Select(sponsorOrganisationDto => new WorkspaceCardModel
        {
            Permission = Permissions.Sponsor.Workspace_Access,
            Title = sponsorOrganisationDto.SponsorOrganisationName,
            Desc = "",
            Link = "sws:modifications",
            Dictionary = new Dictionary<string, string>
            {
                { "sponsorOrganisationUserId", Model.SponsorOrganisationUserId.ToString() },
                { "rtsId", sponsorOrganisationDto.RtsId }
            }
        })
        .ToList();

    var authorizedChunks = cards
        .Where(item => User.HasPermission(item.Permission!))
        .Select((card, index) => new { card, index })
        .GroupBy(x => x.index / 3)
        .Select(g => g.Select(x => x.card).ToList())
        .ToList();
}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
        <h1 class="govuk-heading-xl">@Html.Raw(headline?.Value)</h1>
        @foreach (var row in authorizedChunks)
        {
            <div>
                @foreach (var item in row)
                {
                    <div permission="@item.Permission">
                        <partial name="_ActionItem" model="@(item.Title, item.Desc, item.Link, item.Dictionary)"/>
                    </div>
                }
            </div>
        }
    </div>
</div>