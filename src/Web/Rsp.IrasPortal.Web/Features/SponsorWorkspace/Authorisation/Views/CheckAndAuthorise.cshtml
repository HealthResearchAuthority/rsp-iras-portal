@using Microsoft.FeatureManagement
@using Rsp.Gds.Component.Models
@using Rsp.Portal.Application.Constants
@using Rsp.Portal.Application.DTOs.Responses.CmsContent
@using Rsp.Portal.Domain.AccessControl
@using Rsp.Portal.Web.Features.Modifications.Models
@model Rsp.Portal.Web.Features.SponsorWorkspace.Authorisation.Models.AuthoriseModificationsOutcomeViewModel
@inject Microsoft.FeatureManagement.IFeatureManager FeatureManager

@{
    ViewBag.Title = (string?)ViewData[PageContentElements.MetaTitle];

    TempData[TempDataKeys.ProjectModification.ReviewAllChanges] = true;
    ViewData[ViewDataKeys.ShowRemoveLink] = false;
    ViewData[ViewDataKeys.ShowModificationChangeStatus] = false;
    ViewData[ViewDataKeys.ShowModificationStatus] = true;
    ViewData[ViewDataKeys.IsSponsorCheckAndAuthorise] = true;
    ViewData[ViewDataKeys.ShowModificationDetails] = Model.Status != ModificationStatus.WithSponsor;

    ViewBag.SponsorOrganisationUserId = Model.SponsorOrganisationUserId;

    var isAuthoriser = TempData[TempDataKeys.IsAuthoriser] as bool? ?? false;

    var pageContentData = (Dictionary<string, MixedContentPageItem?>?)ViewData[PageContentElements.PageContent];
    var pageContent = pageContentData ?? new Dictionary<string, MixedContentPageItem?>();

    var headline = pageContent.GetValueOrDefault("SponsorWorkspace.CheckAndAuthorise.Title", null);
    var actionedModificationHeadline = pageContent.GetValueOrDefault("SponsorWorkspace.CheckAndAuthorise.ModificationActionedTitle", null);
    var rankingTitle = pageContent.GetValueOrDefault("SponsorWorkspace.CheckAndAuthorise.RankingTitle", null);
    var outcomeTitle = pageContent.GetValueOrDefault("SponsorWorkspace.CheckAndAuthorise.OutcomeTitle", null);
    var outcome = pageContent.GetValueOrDefault("SponsorWorkspace.CheckAndAuthorise.Outcome", null);

    // Detect field error for summary styling
    var hasError = ViewData.ModelState.TryGetValue(nameof(Model.Outcome), out var entry) && entry!.Errors.Any();       

    // Radio options for the TagHelper
    var outcomeOptions = new List<GdsOption>
    {
        new() { Value = "Authorised", Label = "Authorised" },
        new() { Value = "NotAuthorised", Label = "Not authorised" },
        new() { Value = "ReviseAndAuthorise", Label = "Revise and authorise" }
    };
        
    if (ViewBag.RevisionSent == false)
    {
        outcomeOptions.Add(new GdsOption
        {
            Value = "RequestRevisions",
            Label = "Request revisions"
        });
    };

    if (await FeatureManager.IsEnabledAsync(FeatureFlags.RevisionAndAuthorisation))
    {
        outcome = pageContent.GetValueOrDefault("SponsorWorkspace.CheckAndAuthorise.Outcome_Additional", null);

        outcomeOptions.Add(new GdsOption
        {
            Value = "ReviseAndAuthorise",
            Label = "Revise and authorise"
        });

        outcomeOptions.Add(new GdsOption
        {
            Value = "RequestRevisions",
            Label = "Request revisions"
        });
    }
}

@section Breadcrumb {
    @await Html.PartialAsync("_Breadcrumb", new List<(string, string?)>
    {
        ("Sponsor workspace", Url.RouteUrl("sws:sponsorworkspace")),
        ("Authorisations", Url.RouteUrl("sws:modifications", new { sponsorOrganisationUserId = Model.SponsorOrganisationUserId }))
    })
}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
        <h1 status-for="Status"
        status-is="@ModificationStatus.WithSponsor"
        class="govuk-heading-l">
            @Html.Raw(headline?.Value)
        </h1>

        <h1 status-for="Status"
        status-is="@ModificationStatus.WithSponsor"
        status-mode="Hide"
        class="govuk-heading-l">
            @Html.Raw(actionedModificationHeadline?.Value)
        </h1>

        <partial name="_ValidationSummary" model="@(ViewData.ModelState, "There is a problem")" />

        <partial name="~/Features/Modifications/Shared/_ProjectModificationSummary.cshtml"
        model="Model"
        view-data="ViewData" />

        <h2 class="govuk-heading-m">Summary details</h2>
        <div class="govuk-summary-card">
            <div class="govuk-summary-card__title-wrapper">
                <h2 class="govuk-summary-card__title">
                    @Html.Raw(rankingTitle?.Value)
                </h2>
            </div>
            <div class="govuk-summary-card__content">
                @{
                    var ranking = new RankingOfChangeViewModel
                    {
                        ModificationType = Model.ModificationType,
                        Category = Model.Category,
                        ReviewType = Model.ReviewType
                    };
                }
                <partial name="~/Features/Modifications/Shared/RankingOfChange.cshtml"
                model="ranking" />
            </div>
        </div>
    </div>
</div>

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
        <partial name="~/Features/Modifications/Views/_NavigationTabPartial.cshtml"
        model="Model"
        view-data="ViewData" />
    </div>
</div>

@if (isAuthoriser)
{
    <authorized permission="@Permissions.Sponsor.Modifications_Authorise"
                status-for="Status"
                status-is="@ModificationStatus.WithSponsor">
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                <h2 class="govuk-heading-m">@Html.Raw(outcomeTitle?.Value)</h2>
                @Html.Raw(outcome?.Value)
            </div>
        </div>

        <form method="post">
            <!-- round-trip context -->
            <input type="hidden" name="ProjectRecordId" value="@Model.ProjectRecordId" />
            <input type="hidden" name="IrasId" value="@Model.IrasId" />
            <input type="hidden" name="ShortTitle" value="@Model.ShortTitle" />
            <input type="hidden" name="ModificationId" value="@Model.ModificationId" />
            <input type="hidden" name="SponsorOrganisationUserId" value="@Model.SponsorOrganisationUserId" />
            <input type="hidden" name="ProjectModificationId" value="@Model.ProjectModificationId" />
            <input type="hidden" name="ReviewType" value="@Model.ReviewType" />
            <input type="hidden" name="ModificationIdentifier" value="@Model.ModificationIdentifier" />

            <div class="govuk-form-group @(hasError ? "govuk-form-group--error" : "")">

                @if (hasError)
                {
                    <p class="govuk-error-message">
                        @ViewData.ModelState[nameof(Model.Outcome)]?.Errors?.FirstOrDefault()?.ErrorMessage
                    </p>
                }

                <rsp-gds-radio-group asp-for="Outcome"
                                     label-text=" "
                                     label-css-class="govuk-label govuk-label--s font-weight-none"
                                     options="outcomeOptions"
                                     div-inline-class="govuk-radios"
                                     hint-html="">
                </rsp-gds-radio-group>
            </div>

            <partial name="_SubmitButton"
                     model="@("sws:checkandauthorise", "Confirm selection", new Dictionary<string, string>())" />
        </form>
    </authorized>
}