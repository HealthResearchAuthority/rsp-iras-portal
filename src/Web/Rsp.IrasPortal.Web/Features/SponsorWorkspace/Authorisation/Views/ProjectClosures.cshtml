@using Rsp.Portal.Web.Features.SponsorWorkspace.Authorisation.Models
@using Microsoft.FeatureManagement
@using Rsp.Portal.Application.Constants
@using Rsp.Portal.Application.DTOs.Responses;
@using System.Linq
@using Rsp.Portal.Application.DTOs.Responses.CmsContent
@using Rsp.Portal.Web.Areas.Admin.Models

@model ProjectClosuresViewModel

@section Breadcrumb {
    @if (Model.SponsorOrgansationCount > 1)
    {
        @await Html.PartialAsync("_Breadcrumb", new List<(string, string?)>
        {
            ("Sponsor workspace", Url.RouteUrl("sws:sponsorworkspace")),
            ("Authorisations", Url.RouteUrl("sws:sponsorselector", new { SponsorOrganisationUserId = Model.SponsorOrganisationUserId.ToString() }))
        })
    }
    else
    {
        @await Html.PartialAsync("_Breadcrumb", new List<(string, string?)>
        {
            ("Sponsor workspace", Url.RouteUrl("sws:sponsorworkspace")),
        })
    }
}

@{
    var errorSummaryTitle = "There is a problem";
	ViewBag.Title = (string?)ViewData[PageContentElements.MetaTitle];
    ViewBag.Active = SponsorAuthorisations.ProjectClosures;

    var pageContentData = (Dictionary<string, MixedContentPageItem?>?)ViewData[PageContentElements.PageContent];
    var pageContent = pageContentData != null
        ? pageContentData
        : new Dictionary<string, MixedContentPageItem?>();

    var headline = pageContent.GetValueOrDefault("SponsorWorkspace.ProjectClosures.Title", null);
    var searchHint = pageContent.GetValueOrDefault("SponsorWorkspace.ProjectClosures.SearchHint", null);
}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">

        <partial name="_ValidationSummary" model="(ViewData.ModelState, errorSummaryTitle)" />
        <h2 class="govuk-heading-l" id="title">
            @Html.Raw(headline?.Value)
            @(Model.SponsorOrgansationCount > 1 
                ? $" for {Model.SponsorOrganisationName}" 
                : string.Empty)
        </h2>

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">

                <form asp-route="sws:applyprojectclosuresfilters" method="post" class="govuk-form-group govuk-!-margin-bottom-0">

                    <div class="govuk-form-group govuk-!-margin-bottom-2" error-class-for="Search.SearchTerm">
                        
                        <div id="search-hint" class="govuk-hint">
                            @Html.Raw(searchHint?.Value)
                        </div>

                        @Html.ValidationMessageFor(model => model.Search.SearchTerm, "", new { @class = "govuk-error-message" })

                        <div class="govuk-input__wrapper">
                            <span id="find-project-label" class="govuk-visually-hidden">Find a project</span>
                            <input asp-for="Search.SearchTerm" class="govuk-input" type="text" id="SearchTerm" aria-labelledby="find-project-label"/>
                            <button class="govuk-button mb-0" style="margin-left:10px" type="submit">
                                Search
                            </button>
                        </div>
                    </div>

                    <input hidden asp-for="SponsorOrganisationUserId" />
                    <input hidden asp-for="RtsId" />
                    <input hidden readonly name="PageSize" value="@Model.Pagination?.PageSize" />
                    <input hidden readonly name="PageNumber" value="@Model.Pagination?.PageNumber" />
                </form>
            </div>
        </div>

        <partial name="_AuthorisationsNavigationTabPartial" model="@(Model.SponsorOrganisationUserId, Model.RtsId)" />

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
                <div class="govuk-table-wrapper">
                    <table class="govuk-table modifications-tasklist-table" id="projectClosureTable">
                        <thead class="govuk-table__head">
                            <tr class="govuk-table__row govuk-table__header-sortable govuk-body-s">
                                @{
                                    var sortableHeaders = new[]
                                    {
                                                                new { Field = nameof(ProjectClosuresModel.ShortProjectTitle), Label = "Short project title" },
                                                                new { Field = nameof(ProjectClosuresModel.IrasId), Label = "IRAS ID" },
                                                                new { Field = nameof(ProjectClosuresModel.SentToSponsorDate), Label = "Date received" },
                                                                new { Field = nameof(ProjectClosuresModel.UserEmail), Label = "User email" },
                                                                new { Field = nameof(ProjectClosuresModel.ClosureDate), Label = "Date closed" },
                                                                new { Field = nameof(ProjectClosuresModel.Status), Label = "Status" }
                                                                };
                                    var tableId = "projectClosureTable";
                                }
                                @foreach (var header in sortableHeaders)
                                {
                                    <th scope="col" class="govuk-table__header govuk-table__header-sortable">
                                        <partial name="_SortableHeaderButton" model="@(new SortableHeaderModel
                                                                              {
                                                                                  FieldName = header.Field,
                                                                                  DisplayText = header.Label,
                                                                                  CurrentSortField = Model.Pagination?.SortField,
                                                                                  CurrentSortDirection = Model.Pagination?.SortDirection,
                                                                                  TableId = tableId,
                                                                                  AdditionalParameters = new Dictionary<string, string>
                                                                                  {
                                                                                      { "SponsorOrganisationUserId", Model.SponsorOrganisationUserId.ToString() }
                                                                                  }
                                                                              })" />
                                    </th>
                                                                }
                            </tr>
                        </thead>

                        <form method="get" id="projectclosures-selection">
                            <input hidden="hidden" type="text" value="@Model.Pagination.SortField" name="sortField" />
                            <input hidden="hidden" type="text" value="@Model.Pagination.SortDirection" name="sortDirection" />

                        <tbody class="govuk-table__body govuk-body-s">
                            @{
                                foreach (var projectRecord in Model.ProjectRecords)
                                {
                                    <tr class="govuk-table__row">
                                        <td class="govuk-table__cell">
                                            <a class="govuk-link"
                                               asp-route="@(projectRecord.Status == ProjectClosureStatus.WithSponsor ? "sws:checkandauthoriseprojectclosure" : "pov:projectdetails")"
                                               asp-route-projectRecordId="@projectRecord.ProjectRecordId"                                              
                                               asp-route-sponsorOrganisationUserId="@Model.SponsorOrganisationUserId"
                                               asp-route-rtsId="@Model.RtsId">
                                                <strong>@projectRecord.ShortProjectTitle</strong>
                                            </a>
                                        </td>
                                        <td class="govuk-table__cell">@projectRecord.IrasId</td>
                                        <td class="govuk-table__cell">@(projectRecord.SentToSponsorDate?.ToString("dd MMM yyyy") ?? string.Empty)</td>
                                        <td class="govuk-table__cell">@projectRecord.UserEmail</td>
                                        <td class="govuk-table__cell">
                                            @(projectRecord.Status == ProjectClosureStatus.Authorised
                                                                                ? projectRecord.ClosureDate?.ToString("dd MMM yyyy") ?? string.Empty
                                                                                : string.Empty)                                        
                                        </td>
                                        <td class="govuk-table__cell">
                                            @{
                                                var tagClass = projectRecord.Status switch
                                                {
                                                    ProjectClosureStatus.WithSponsor => "govuk-tag--yellow",                                                    
                                                    ProjectClosureStatus.Authorised => "govuk-tag--green",                                                    
                                                    ProjectClosureStatus.NotAuthorised => "govuk-tag--red",
                                                    _ => "govuk-tag--blue"
                                                };
                                            }
                                            <strong class="govuk-tag @tagClass">
                                                @projectRecord.Status
                                            </strong>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                        </form>
                    </table>
                </div>
                <partial name="_Pagination" model="@Model.Pagination" />
            </div>
        </div>
    </div>
</div>