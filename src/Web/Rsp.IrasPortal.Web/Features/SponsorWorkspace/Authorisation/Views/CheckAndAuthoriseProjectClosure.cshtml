@using Rsp.Gds.Component.Models
@using Rsp.Portal.Application.Constants
@using Rsp.Portal.Application.DTOs.Responses.CmsContent
@using Rsp.Portal.Domain.AccessControl
@using Rsp.Portal.Web.Features.Modifications.Models
@model Rsp.Portal.Web.Features.SponsorWorkspace.Authorisation.Models.AuthoriseProjectClosuresOutcomeViewModel

@{
    ViewBag.Title = (string?)ViewData[PageContentElements.MetaTitle];
    ViewBag.SponsorOrganisationUserId = Model.SponsorOrganisationUserId;
    ViewBag.RtsId = Model.RtsId;

    var isAuthoriser = TempData[TempDataKeys.IsAuthoriser] as bool? ?? false;

    var pageContentData = (Dictionary<string, MixedContentPageItem?>?)ViewData[PageContentElements.PageContent];
    var pageContent = pageContentData ?? new Dictionary<string, MixedContentPageItem?>();

    var headline = pageContent.GetValueOrDefault("SponsorWorkspace.CheckAndAuthoriseProjectClosure.Title", null);
    var plannedProjectEndDateLabel = pageContent.GetValueOrDefault("SponsorWorkspace.CheckAndAuthoriseProjectClosure.PlannedProjectEndDateLabel", null);
    var actualProjectClosureDateLabel = pageContent.GetValueOrDefault("SponsorWorkspace.CheckAndAuthoriseProjectClosure.ActualProjectClosureDateLabel", null);
    var outcomeTitle = pageContent.GetValueOrDefault("SponsorWorkspace.CheckAndAuthoriseProjectClosure.OutcomeTitle", null);
    var outcome = pageContent.GetValueOrDefault("SponsorWorkspace.CheckAndAuthoriseProjectClosure.Outcome", null);

    // Detect field error for summary styling
    var hasError = ViewData.ModelState.TryGetValue(nameof(Model.Outcome), out var entry) && entry!.Errors.Any();

    // Radio options for the TagHelper
    var outcomeOptions = new List<GdsOption>
    {
        new() { Value = "Authorised", Label = "Authorised" },
        new() { Value = "NotAuthorised", Label = "Not authorised" }
    };
}

@section BackNavigation {
    <partial name="_BackNavigation" model="@("sws:projectclosures", "Back", new Dictionary<string, string> { { "sponsorOrganisationUserId", Model.SponsorOrganisationUserId.ToString() } })" />
}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
        <h1 class="govuk-heading-l">
            @Html.Raw(headline?.Value)            
        </h1>        

        <partial name="_ValidationSummary" model="@(ViewData.ModelState, "There is a problem")" />

        <div class="govuk-inset-text">
            <p>
                <strong>IRAS ID:</strong> @Model.IrasId
            </p>
            @if (!string.IsNullOrEmpty(Model.ShortProjectTitle))
            {
                <p>
                    <strong>Short project title:</strong> @Model.ShortProjectTitle
                </p>
            }
        </div>

        <p class="govuk-!-margin-bottom-6">
            @Html.Raw(plannedProjectEndDateLabel?.Value)
            <strong class="govuk-!-margin-left-3">@Model.PlannedEndDate</strong>
        </p>

        <p class="govuk-!-margin-bottom-6">
            @Html.Raw(actualProjectClosureDateLabel?.Value)
            <strong class="govuk-!-margin-left-3">@Model.ActualEndDate</strong>
        </p>
    </div>
</div>

@if (isAuthoriser)
{   
    <authorized permission="@Permissions.Sponsor.ProjectClosures_Authorise">
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                <h2 class="govuk-heading-m">@Html.Raw(outcomeTitle?.Value)</h2>
                @Html.Raw(outcome?.Value)
            </div>
        </div>

        <form method="post">
            <!-- round-trip context -->
            <input type="hidden" name="ProjectRecordId" value="@Model.ProjectRecordId" />              
            <input type="hidden" name="SponsorOrganisationUserId" value="@Model.SponsorOrganisationUserId" />        
            <input type="hidden" name="IrasId" value="@Model.IrasId" />
            <input type="hidden" name="ShortProjectTitle" value="@Model.ShortProjectTitle" />
            <input type="hidden" name="RtsId" value="@Model.RtsId" />

            <div class="govuk-form-group @(hasError ? "govuk-form-group--error" : "")">

                @if (hasError)
                {
                    <p class="govuk-error-message">
                        @ViewData.ModelState[nameof(Model.Outcome)]?.Errors?.FirstOrDefault()?.ErrorMessage
                    </p>
                }

                <rsp-gds-radio-group asp-for="Outcome"
                                     label-text=" "
                                     label-css-class="govuk-label govuk-label--s font-weight-none"
                                     options="outcomeOptions"
                                     div-inline-class="govuk-radios"
                                     hint-html="">
                </rsp-gds-radio-group>
            </div>

            <partial name="_SubmitButton"
                     model="@("sws:checkandauthoriseprojectclosure", "Confirm selection", new Dictionary<string, string>())" />
        </form>
    </authorized>
}
