@using Rsp.IrasPortal.Application.DTOs
@model Rsp.IrasPortal.Application.DTOs.QuestionSetDto

@{
	var flowStep = ViewBag.Step as string ?? "version";
	var versionId = Model.Version?.VersionId ?? "";
	var questions = Model.Questions?.ToList() ?? new List<QuestionDto>();
	var currentIndex = ViewBag.QuestionIndex as int? ?? (questions.Count > 0 ? questions.Count - 1 : 0);

    var isEditing = currentIndex < questions.Count;
	var questionButtonText = isEditing ? "Update this question" : "Add this question";

        var headingText = isEditing ? $"Edit Question ID: {questions[currentIndex].QuestionId}" : "Add new question";
}

<div class="govuk-grid-row">
	<div class="govuk-grid-column-two-thirds">
		<h1 class="govuk-heading-l">Create a Question Set</h1>

		@if (flowStep == "version")
		{
			<form asp-action="NextStep" asp-controller="QuestionSet" method="post">
				<fieldset>
					<legend class="govuk-fieldset__legend govuk-fieldset__legend--m">Version details</legend>

					@if (!string.IsNullOrWhiteSpace(Model.Version?.VersionId))
					{
						<p class="govuk-hint">The version ID cannot be changed after this point.</p>
						<rsp-gds-input asp-for="Version.VersionId" label-text="Version ID" readonly="true" disabled="true" />
						<input type="hidden" name="Version.VersionId" value="@Model.Version.VersionId" />
					}
					else
					{
						<rsp-gds-input asp-for="Version.VersionId" label-text="Version ID" />
					}
				</fieldset>

				<button type="submit" class="govuk-button">Next</button>
			</form>
		}
		else if (flowStep == "questions")
		{
						<!-- Back button -->
			<form asp-action="Back" asp-controller="QuestionSet" method="post" class="govuk-!-margin-bottom-4">
				<input type="hidden" name="versionId" value="@versionId" />
				<input type="hidden" name="questionIndex" value="@currentIndex" />
				<button type="submit" class="govuk-button govuk-button--secondary">Back</button>
			</form>


			var question = questions.Count > currentIndex ? questions[currentIndex] : new QuestionDto { VersionId = versionId };

			<h2 class="govuk-heading-m">@headingText</h2>

			<!-- Question input form -->
            <form asp-action="AddQuestion" asp-controller="QuestionSet" method="post">
				<input type="hidden" name="versionId" value="@versionId" />
                <input type="hidden" name="questionIndex" value="@currentIndex" />
                @await Html.PartialAsync("_QuestionEditor", question, new ViewDataDictionary(ViewData) { { "Index", currentIndex } })
                <button type="submit" class="govuk-button">@questionButtonText</button>
            </form>

			@if (questions.Any())
			{
				<h2 class="govuk-heading-m govuk-!-margin-top-6">Current questions</h2>

				@if (questions.Any())
				{
					<div class="govuk-grid-column-full">
						<div class="govuk-table-wrapper">
							<table class="govuk-table">
								<thead class="govuk-table__head">
									<tr class="govuk-table__row govuk-table__header-sortable govuk-body-s">
										<th scope="col" class="govuk-table__header govuk-!-width-one-quarter">Question ID</th>
										<th scope="col" class="govuk-table__header govuk-!-width-one-quarter">Question Text</th>
										<th scope="col" class="govuk-table__header govuk-!-width-one-quarter">Category</th>
										<th scope="col" class="govuk-table__header govuk-!-width-one-quarter">Actions</th>
									</tr>
								</thead>
								<tbody class="govuk-table__body">
									@for (int i = 0; i < questions.Count; i++)
									{
										var q = questions[i];
										<tr class="govuk-table__row">
											<td class="govuk-table__cell">@q.QuestionId</td>
											<td class="govuk-table__cell">@q.QuestionText</td>
											<td class="govuk-table__cell">@q.Category</td>
											<td class="govuk-table__cell">
												<form asp-action="EditQuestion" asp-controller="QuestionSet" method="post" class="inline-form">
													<input type="hidden" name="versionId" value="@versionId" />
													<input type="hidden" name="questionIndex" value="@i" />
													<button type="submit" class="govuk-button govuk-button--secondary">Edit</button>
												</form>
											</td>
										</tr>
									}
								</tbody>
							</table>
						</div>
					</div>
					<form asp-action="Save" asp-controller="QuestionSet" method="post">
						<input type="hidden" name="versionId" value="@versionId" />
						<button type="submit" class="govuk-button govuk-button--primary">Save Question Set</button>
					</form>
				}
			}
		}
	</div>
</div>
