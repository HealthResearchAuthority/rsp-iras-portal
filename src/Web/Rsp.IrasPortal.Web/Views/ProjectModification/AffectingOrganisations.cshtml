@using System.Text.Json
@using Rsp.IrasPortal.Application.Constants
@using Rsp.Gds.Component.Models
@model Rsp.IrasPortal.Web.Models.AffectingOrganisationsViewModel

@{
    ViewData["Title"] = "Planned End Date";
    var errorSummaryTitle = "There is a problem";

    var selectedOrgTypes = TempData.Peek(TempDataKeys.ProjectModificationPlannedEndDate.AffectingOrganisationsType) as string;

    var selectedOrgs = new List<string>();

    if (!string.IsNullOrEmpty(selectedOrgTypes))
    {
        selectedOrgs = JsonSerializer.Deserialize<List<string>>(selectedOrgTypes)!;
    }

    var isReviewInProgress = TempData.Peek(TempDataKeys.ProjectModificationPlannedEndDate.ReviewChanges) is true;

    var navModel = (isReviewInProgress ? "pmc:modificationchangesreview" : "pmc:plannedenddateorganisationtype", "Back", new Dictionary<string, string>());
}

@section BackNavigation {
    <partial name="_BackNavigation" model="navModel" />
}

<partial name="_ValidationSummary" model="(ViewData.ModelState, errorSummaryTitle)" />

<div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">

        <form method="post">

            <partial name="_ProjectModificationSummary" model="Model" />

            <span class="govuk-label govuk-label--m">
                Where are the participating NHS/HSC organisations that will be affected by this change?
            </span>

            <div class="govuk-checkboxes govuk-checkboxes--small">
                <rsp-gds-checkbox-group asp-for="SelectedLocations"
                                        options="Model.ParticipatingOrganisationsLocations.Select(ot => ot.Value)"
                                        conditional-field="false"
                                        legend-class="govuk-hint"
                                        label-text="Select all that apply" />
            </div>

            @if (!string.IsNullOrWhiteSpace(selectedOrgs.FirstOrDefault(org => org == "NHS/HSC")))
            {
                <rsp-gds-radio-group asp-for="SelectedAffectedOrganisations"
                                     options="Model.AffectedOrganisations.Select
                                              (
                                                  opt => new GdsOption
                                                  {
                                                      Value = Html.Encode(opt.Key),
                                                      Label = Html.Encode(opt.Value)
                                                  }
                                              )"
                                     div-inline-class="govuk-radios govuk-radios--small"
                                     label-text="Will some or all of the participating organisations be affected?"
                                     legend-class="govuk-label govuk-label--m"
                                     hint-html="This answer may affect the categorisation for the change"
                                     validation-message="Select one option for affected organisations" />

                <rsp-gds-radio-group asp-for="SelectedAdditionalResources"
                                     options="Model.AdditionalResources.Select
                                              (
                                                  opt => new GdsOption
                                                  {
                                                      Value = Html.Encode(opt.Key),
                                                      Label = Html.Encode(opt.Value)
                                                  }
                                              )"
                                     div-inline-class="govuk-radios govuk-radios--small"
                                     label-text="Will participating NHS/HSC organisations require additional resources to implement this change?"
                                     legend-class="govuk-label govuk-label--m"
                                     validation-message="Select one option for additional resources" />
            }

            <div class="save-buttons">

                @{
                    var buttonText = isReviewInProgress ? "Save changes" : "Save and continue";
                }

                <partial name="_SubmitButton" model="@("pmc:saveaffectedorganisationsresponses", buttonText, new Dictionary<string, string>())" />

                @if (!isReviewInProgress)
                {
                    ViewBag.Style = "govuk-button govuk-button--secondary";

                    <partial name="_SubmitButton" model="@("pmc:saveaffectedorganisationsresponses", "Save for later", new Dictionary<string, string> {{ "saveForLater", bool.TrueString }})" />
                }
            </div>

            <p>
                <a href="#" class="govuk-link">Remove this change</a>
            </p>
        </form>
    </div>
</div>