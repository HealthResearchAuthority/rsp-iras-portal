@using Rsp.Portal.Application.Constants
@using Rsp.Portal.Application.DTOs.Responses
@using Rsp.Portal.Web.Models
@using System.Text.Json
@model ProjectOverviewModel
@{
    ViewBag.Title = "Project history";
    ViewBag.Active = ProjectOverview.ProjectHistory;
}

@{
    var routeName = (ViewData["BackRoute"] as string) ?? "app:Welcome";
    var routeValues = ViewData["BackRouteValues"] as Dictionary<string, string>
                      ?? new Dictionary<string, string>();
    var modificationId = Context.Request.Query["modificationId"].ToString();
    var projectTitle = !string.IsNullOrEmpty(Model.ProjectTitle) ? Model.ProjectTitle : "Project overview";

    var tdBackRouteValues = TempData.Peek(TempDataKeys.ProjectOverviewReferrer.BackRouteValues);

    var backRouteValues = JsonSerializer.Deserialize<Dictionary<string, string>>
        (tdBackRouteValues != null ? tdBackRouteValues.ToString()! : "{}") ?? new Dictionary<string, string>();
}

@if (routeName is null || routeName.ToLower() == "app:welcome")
{
    @section Breadcrumb {
	    @await Html.PartialAsync("_Breadcrumb", new List<(string, string?)>
	    {
		    ("My research",Url.RouteUrl("app:welcome")),
		    (projectTitle, Url.RouteUrl("pov:projectdetails", new Dictionary<string, string>{{"projectRecordId", Model?.ProjectRecordId!}}))
	    })
    }
}
else
{
    @section BackNavigation {
        <partial name="_BackNavigation" model="@(routeName, "Back", backRouteValues)" />
    }
}

@if (TempData[TempDataKeys.ShowNotificationBanner] is not null)
{
    <partial name="_NotificationBanner"
             model="@(new NotificationBannerModel
                    {
                        Title = "Success",
                        Heading = $"Modification {modificationId} has been deleted"
                    })" />
}

<partial name="_NavigationHeaderPartial" model="@Model" />

<div class="govuk-grid-row govuk-!-margin-top-4">
    <div class="govuk-grid-column-full">
        <h2 class="govuk-heading-m">Project history</h2>
        <div class="govuk-table-wrapper">
            <table class="govuk-table govuk-table-users">
                <thead>
                    <tr>
                        <th class="govuk-table__header govuk-table__header-sortable govuk-table--name">Date</th>
                        <th class="govuk-table__header govuk-table__header-sortable govuk-table--name">Event description</th>
                        <th class="govuk-table__header govuk-table__header-sortable govuk-table--name">Modification ID</th>
                        <th class="govuk-table__header govuk-table__header-sortable govuk-table--email line-break-anywhere">Actioned by</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var record in Model.AuditTrails)
                    {
                        <tr class="govuk-table__row">
                            <td class="govuk-table__cell">@record.DateTimeStamp.ToString("dd MMMM yyyy")</td>
                            <td class="govuk-table__cell">@record.Description</td>
                            <td class="govuk-table__cell line-break-anywhere">
                                @(string.IsNullOrWhiteSpace(record.ModificationIdentifier)
                                    ? "Not applicable"
                                    : record.ModificationIdentifier)
                            </td>
                            <td class="govuk-table__cell line-break-anywhere">@record.User</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>