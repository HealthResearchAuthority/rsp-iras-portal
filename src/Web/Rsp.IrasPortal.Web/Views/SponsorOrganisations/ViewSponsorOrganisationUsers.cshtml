@using Rsp.IrasPortal.Application.Constants
@using Rsp.IrasPortal.Application.DTOs
@using Rsp.IrasPortal.Application.DTOs.Responses.CmsContent
@using Rsp.IrasPortal.Web.Areas.Admin.Models
@model SponsorOrganisationListUsersModel

@{
    ViewBag.Title = "View users - Manage sponsor organisations - System Administration";

    var sortableHeaders = new[]
    {
        new { Field = nameof(UserViewModel.GivenName), Label = "Given name" },
        new { Field = nameof(UserViewModel.FamilyName), Label = "Family name" },
        new { Field = nameof(UserViewModel.Email), Label = "Email address" },
        new { Field = nameof(UserViewModel.Status), Label = "Status" },
        new { Field = nameof(UserViewModel.CurrentLogin), Label = "Last logged in" }
    };
    var tableId = "sponsorOrganisationTable";

    var pageContentData = (Dictionary<string, MixedContentPageItem?>?)ViewData[PageContentElements.PageContent];
    var pageContent = pageContentData != null
        ? pageContentData
        : new Dictionary<string, MixedContentPageItem?>();

    var headline = pageContent.GetValueOrDefault("SponsorOrganisations.ViewUsers.Title", null);
    var body = pageContent.GetValueOrDefault("SponsorOrganisations.ViewUsers.Body", null);
    var addNewLink = pageContent.GetValueOrDefault("SponsorOrganisations.ViewUsers.AddNewLink", null);
    var searchTitle = pageContent.GetValueOrDefault("SponsorOrganisations.ViewUsers.SearchTitle", null);
    var searchHint = pageContent.GetValueOrDefault("SponsorOrganisations.ViewUsers.SearchHint", null);
}

@* @section is added for the back button, so that we can render something below the back button
    and before the RenderBody() in the _Layout.cshtml. As RenderBody() renders anything that is not within
    the named section *@

@section BackNavigation {
    <partial name="_BackNavigation" model="@("soc:viewsponsororganisation", "Back to sponsor organisation profile", new Dictionary<string, string> { { "RtsId", Model.SponsorOrganisation.RtsId } })"/>
}

@if (TempData[TempDataKeys.ShowNotificationBanner] is not null)
{
    var notificationBanner = TempData[TempDataKeys.SponsorOrganisationUserType] switch
    {
		"add" => "User added to this organisation",
        "enable" => "User enabled",
        "disable" => "User disabled",
        _ => null
    };

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            <partial name="_NotificationBanner" model="@("Success", notificationBanner)" />
        </div>
    </div>
}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
        <h1 class="govuk-heading-l">@Html.Raw(headline?.Value) @Model.SponsorOrganisation.SponsorOrganisationName</h1>
        <p class="govuk-body">@Html.Raw(body?.Value)</p>
    </div>

    <div class="govuk-grid-column-one-third">
        <a class="govuk-link govuk-body float-right" asp-route="soc:viewadduser" asp-all-route-data="@(new Dictionary<string, string> { { "rtsId", Model.SponsorOrganisation.RtsId } })">@Html.Raw(addNewLink?.Value)</a>
    </div>
</div>

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">

        <form method="get">
            <label class="govuk-label" for="Search.SearchQuery">
                <b>@Html.Raw(searchTitle?.Value)</b>
            </label>
            <div class="govuk-hint">
                @Html.Raw(searchHint?.Value)
            </div>
            <input class="govuk-input govuk-!-width-two-thirds" id="SearchQuery" name="SearchQuery" type="text" value="@(Model.Pagination?.SearchQuery ?? string.Empty)">
            <input hidden readonly name="RtsId" value="@Model.SponsorOrganisation.RtsId"/>
            <input hidden readonly name="PageSize" value="@Model.Pagination?.PageSize"/>
            @{
                ViewBag.Style = "govuk-button govuk-button--secondary";
            }
            <partial name="_SubmitButton" model="@("soc:viewsponsororganisationusers", "Search", new Dictionary<string, string>())"/>
        </form>
    </div>
    @if (Model.Users != null && Model.Users.Any())
    {
        <div class="govuk-grid-column-full">
            <div class="govuk-table-wrapper">

                <table class="govuk-table govuk-table-users">
                    <thead>
                    <tr class="govuk-table__row govuk-table__header-sortable govuk-body-s">
                        @foreach (var header in sortableHeaders)
                        {
                            var sortableHeaderModel = new SortableHeaderModel
                            {
                                FieldName = header.Field,
                                DisplayText = header.Label,
                                CurrentSortField = Model.Pagination?.SortField,
                                CurrentSortDirection = Model.Pagination?.SortDirection,
                                TableId = tableId,
                                AdditionalParameters = new Dictionary<string, string>
                                {
                                    { "rtsId", Model.SponsorOrganisation.RtsId },
												{ "searchQuery", Model.Pagination.SearchQuery }
                                }
                            };

                            <th scope="col" class="govuk-table__header govuk-table__header-sortable">
                                <partial name="_SortableHeaderButton" model="@sortableHeaderModel"/>
                            </th>
                        }
                        <th class="govuk-table__header">Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach (var user in Model.Users)
                    {
                        <tr class="govuk-table__row">
                            <td class="govuk-table__cell">@user.GivenName</td>
                            <td class="govuk-table__cell">@user.FamilyName</td>
                            <td class="govuk-table__cell line-break-anywhere">@user.Email</td>
                            <td class="govuk-table__cell">
                                @{
                                    var sponsorOrganisationUserDto = Model.SponsorOrganisation.Users.FirstOrDefault(x => x.UserId == Guid.Parse(user.Id));
                                    var statusClass = sponsorOrganisationUserDto.IsActive ? "govuk-tag--green" : "govuk-tag--red";
                                    var statusText = sponsorOrganisationUserDto.IsActive ? "Active" : "Disabled";
                                }

                                <strong class="govuk-tag @statusClass">@statusText</strong>
                            </td>
                            <td class="govuk-table__cell">
                                @if (user.CurrentLogin.HasValue)
                                {
                                    var dateString = user.CurrentLogin.Value.ToString("dd MMM yyyy");
                                    var timeString = user.CurrentLogin.Value.ToString("hh:mm");
                                    var amPm = user.CurrentLogin.Value.ToString("tt").ToLower();

                                    var currentLoginDate = $"{dateString} at ";
                                    var currentLoginTime = $"{timeString}{amPm}";

                                    <p class="margin-zero">@currentLoginDate</p>
                                    <p class="margin-zero">@currentLoginTime</p>
                                }
                            </td>
                            <td class="govuk-table__cell">
                                <a class="govuk-link"
                                   asp-route="soc:viewsponsororganisationuser"
                                   asp-route-rtsId="@Model.SponsorOrganisation.RtsId"
                                   asp-route-userId="@user.Id">
                                    View/edit
                                </a>
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
                <partial name="_Pagination" model="@Model.Pagination"/>
            </div>
        </div>
    }
    else if (!string.IsNullOrEmpty(Model.Pagination?.SearchQuery))
    {
        <div class="govuk-grid-column-two-thirds">
            <h1 class="govuk-heading-l">No results found</h1>
            <p class="govuk-body">
                Check your spelling or enter another search term and try again. If no results are found, go to Manage users where you can check if a user profile exists and create one if needed.
            </p>
            <p class="govuk-body">
                <a class="govuk-link" asp-route="soc:viewsponsororganisationusers" asp-all-route-data="@(new Dictionary<string, string> { { "RtsId", Model.SponsorOrganisation.RtsId } })">Back to Users for @Model.SponsorOrganisation.SponsorOrganisationName</a>
            </p>
            <p class="govuk-body">
                <a class="govuk-link" asp-route="admin:users">Manage users</a>
            </p>
        </div>
    }
</div>