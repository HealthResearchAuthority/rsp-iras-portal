@using Rsp.IrasPortal.Application.Constants
@using Rsp.IrasPortal.Application.DTOs.Responses.CmsContent
@model SponsorOrganisationListUsersModel

@{
	ViewBag.Title = "Add a new user profile to sponsor organisation - Manage sponsor organisations - System Administration";

    var pageContentData = (Dictionary<string, MixedContentPageItem?>?)ViewData[PageContentElements.PageContent];
    var pageContent = pageContentData != null
        ? pageContentData
        : new Dictionary<string, MixedContentPageItem?>();

	var headline = pageContent.GetValueOrDefault("SponsorOrganisations.ViewAddUser.Title", null);
	var body = pageContent.GetValueOrDefault("SponsorOrganisations.ViewAddUser.Body", null);
	var searchTitle = pageContent.GetValueOrDefault("SponsorOrganisations.ViewAddUser.SearchTitle", null);
	var searchHint = pageContent.GetValueOrDefault("SponsorOrganisations.ViewAddUser.SearchHint", null);
}

@* @section is added for the back button, so that we can render something below the back button
    and before the RenderBody() in the _Layout.cshtml. As RenderBody() renders anything that is not within
    the named section *@

@section BackNavigation {
    <partial name="_BackNavigation" model="@("soc:viewsponsororganisationusers", "Back", new Dictionary<string, string> { { "RtsId", Model.SponsorOrganisation.RtsId } })"/>
}

@functions {

    private bool HasFilterErrors()
    {
        return ViewData.ModelState.Values.Any(v => v.Errors.Count > 0);
    }

}
<div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
        <h1 class="govuk-heading-l">@Html.Raw(headline?.Value)</h1>
        <p class="govuk-body">@Html.Raw(body?.Value)</p>
    </div>
</div>

<div class="govuk-grid-row">

	<div class="govuk-grid-column-two-thirds">

		<form method="get" class="govuk-form-group">
			<label class="govuk-label" for="SearchQuery">
				<b>@Html.Raw(searchTitle?.Value)</b>
			</label>
			<div class="govuk-label">
				@Html.Raw(searchHint?.Value)
			</div>

			<div class="review-body-search">
				<input class="govuk-input" id="SearchQuery" name="SearchQuery" type="text"
					   value="@(Model.Pagination?.SearchQuery ?? string.Empty)" />

				<input type="hidden" readonly name="RtsId" value="@Model.SponsorOrganisation.RtsId" />
				<input type="hidden" readonly name="PageSize" value="@Model.Pagination?.PageSize" />

				@{
					ViewBag.Style = "govuk-button govuk-button--secondary";
				}
				<partial name="_SubmitButton" model="@("soc:viewadduser", "Search", new Dictionary<string, string>())" />
			</div>

			<!-- Filter Panel -->
			<div class="search-filter-panel">
				<details class="search-filter-toggle" @(HasFilterErrors() ? "open" : null)>
					<summary class="search-filter-panel__header"
							 tabindex="-1"
							 role="button"
							 aria-controls="filter-panel"
							 aria-expanded="@(HasFilterErrors().ToString().ToLower())">

						<span class="search-filter-panel__button-inner govuk-link" tabindex="0">
							Advanced filters
						</span>

						<span class="search-filter-panel__count" aria-hidden="true" tabindex="-1">
							@(Model.Pagination?.TotalCount ?? 0) results
						</span>
					</summary>

					<div class="search-filter-panel__content" id="filter-panel"
						 role="region" aria-labelledby="toggle-filter">

						<!-- Apply -->
						<div class="search-filter-panel__actions">
							<button class="govuk-button search-filter-panel__action search-filter-panel__action--submit">
								Apply filters
							</button>
						</div>

					</div>
				</details>
			</div>

		</form>

	</div>

</div>


<div class="govuk-grid-row">
    

    @if (Model.Users != null && Model.Users.Any())
    {
        <div class="govuk-grid-column-full">
            <div class="govuk-table-wrapper">

                <table class="govuk-table govuk-table-users">
                    <thead>
                    <tr class="govuk-table__row govuk-table__header-sortable govuk-body-s">
                        <th class="govuk-table__header govuk-table--name">First name</th>
                        <th class="govuk-table__header govuk-table--name">Last name</th>
                        <th class="govuk-table__header govuk-table--email line-break-anywhere">Email address</th>
                        <th class="govuk-table__header">Status</th>
                        <th class="govuk-table__header">Last logged in</th>
                        <th class="govuk-table__header">Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach (var user in Model.Users)
                    {
                        <tr class="govuk-table__row">
                            <td class="govuk-table__cell">@user.GivenName</td>
                            <td class="govuk-table__cell">@user.FamilyName</td>
                            <td class="govuk-table__cell line-break-anywhere">@user.Email</td>
                            <td class="govuk-table__cell">
                                @if (!string.IsNullOrEmpty(user.Status))
                                {
                                    var statusClass = string.Equals(user.Status, IrasUserStatus.Active, StringComparison.InvariantCultureIgnoreCase) ? "govuk-tag--green" : "govuk-tag--red";

                                    <strong class="govuk-tag @statusClass">@user.Status</strong>
                                }
                            </td>
                            <td class="govuk-table__cell">
                                @if (user.CurrentLogin.HasValue)
                                {
                                    var dateString = user.CurrentLogin.Value.ToString("dd MMM yyyy");
                                    var timeString = user.CurrentLogin.Value.ToString("hh:mm");
                                    var amPm = user.CurrentLogin.Value.ToString("tt").ToLower();

                                    var currentLoginDate = $"{dateString} at ";
                                    var currentLoginTime = $"{timeString}{amPm}";

                                    <p class="margin-zero">@currentLoginDate</p>
                                    <p class="margin-zero">@currentLoginTime</p>
                                }
                            </td>
                            <td class="govuk-table__cell">
								<a class="govuk-link" 
                                    asp-route="soc:adduserrole" 
                                    asp-route-userId="@user.Id"
                                    asp-route-rtsId="@Model.SponsorOrganisation.RtsId">
                                    Add user
                                </a>
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
                <partial name="_Pagination" model="@Model.Pagination"/>
            </div>
        </div>
    }
    else if (!string.IsNullOrEmpty(Model.Pagination?.SearchQuery))
    {
		<div class="govuk-grid-row">
			<div class="govuk-grid-column-two-thirds search-filter-error-border">
				<h2 class="govuk-heading-m">There are no matching results</h2>
				<p class="govuk-body">Improve your search results by:</p>
				<ul class="govuk-list govuk-list--bullet">
					<li>removing filters</li>
					<li>double-checking your spelling</li>
					<li>using fewer keywords</li>
					<li>searching for something less specific</li>
				</ul>
			</div>
		</div>
    }
</div>